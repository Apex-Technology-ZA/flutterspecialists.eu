---
import BaseLayout from "@layouts/BaseLayout.astro";
import { fetchArticles, fetchArticleBySlug, renderRichText } from "@lib/cms";

export async function getStaticPaths() {
  const { items } = await fetchArticles({ limit: 1000 });
  return items.map((a) => ({ params: { slug: a.slug } }));
}

const { slug } = Astro.params;
const entry = slug ? await fetchArticleBySlug(slug) : null;

if (!entry) {
  Astro.response.status = 404;
}
const html = entry ? renderRichText(entry.body) : "";
---
<BaseLayout
  title={entry ? `${entry.title} — Flutter Specialists` : "Article not found — Flutter Specialists"}
  description={entry?.description}
  canonical={entry ? `https://flutterspecialists.eu/articles/${entry.slug}/` : undefined}
  image={entry?.heroImageUrl ?? "/og-default.svg"}
  noindex={!entry}
>
  {entry ? (
    <section class="container py-10">
      <nav class="mb-4 text-sm text-gray-500">
        <a href="/articles/" class="hover:underline">Articles</a> / {entry.title}
      </nav>
      <h1 class="text-3xl font-bold">{entry.title}</h1>
      <div class="mt-2 text-xs text-gray-500">{new Date(entry.date).toLocaleDateString()}</div>

      {entry.tags && entry.tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-1">
          {entry.tags.map((t) => (
            <a href={`/articles/tag/${encodeURIComponent(t)}/page/1/`} class="text-xs rounded bg-gray-100 px-2 py-0.5 hover:bg-gray-200">{t}</a>
          ))}
        </div>
      )}

      {entry.heroImageUrl && (
        <img src={entry.heroImageUrl} alt="" class="mt-6 rounded" loading="lazy" />
      )}

      <article class="prose prose-slate max-w-none mt-8">
        <div set:html={html} />
      </article>

      {entry.canonical && (
        <p class="mt-8 text-xs text-gray-500">
          Originally published at{" "}
          <a href={entry.canonical} class="underline">{entry.canonical}</a>
        </p>
      )}
    </section>
  ) : (
    <section class="container py-16">
      <h1 class="text-2xl font-bold mb-2">Article not found</h1>
      <p class="text-gray-600">The article you requested does not exist or may have been moved.</p>
      <a href="/articles/" class="inline-block mt-4 text-primary hover:underline">Browse all articles →</a>
    </section>
  )}
</BaseLayout>