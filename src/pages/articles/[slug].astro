---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("articles");
  return entries.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const entries = await getCollection("articles");
const entry = entries.find((p) => p.slug === slug);

if (!entry) {
  Astro.response.status = 404;
}

const rendered = entry ? await entry.render() : null;
const Content = rendered ? rendered.Content : null;
const headings = rendered ? rendered.headings : [];
---
<BaseLayout
  title={entry ? `${entry.data.title} — Flutter Specialists` : "Article not found — Flutter Specialists"}
  description={entry?.data.description}
  canonical={entry ? `https://flutterspecialists.eu/articles/${entry.slug}/` : undefined}
  image={entry?.data.heroImage ?? "/og-default.svg"}
  noindex={!entry}
>
  {entry ? (
    <section class="container py-10">
      <nav class="mb-4 text-sm text-gray-500">
        <a href="/articles/" class="hover:underline">Articles</a> / {entry.data.title}
      </nav>
      <h1 class="text-3xl font-bold">{entry.data.title}</h1>
      <div class="mt-2 text-xs text-gray-500">{new Date(entry.data.date).toLocaleDateString()}</div>

      <!-- Author Bio Section -->
      <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
            ZK
          </div>
          <div>
            <p class="text-sm font-medium text-gray-900">Written by Zayin Krige</p>
            <p class="text-xs text-gray-600">
              South African Flutter developer and founder of
              <a href="https://apextechnology.co.za" class="text-blue-600 hover:underline" target="_blank">Apex Technology</a>
            </p>
          </div>
          <div class="ml-auto">
            <a href="mailto:info@zayinkrige.com" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
              Get in Touch
            </a>
          </div>
        </div>
      </div>

      {Array.isArray(entry.data.tags) && entry.data.tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-1">
          {entry.data.tags.map((t) => (
            <a href={`/articles/?tag=${encodeURIComponent(t)}`} class="text-xs rounded bg-gray-100 px-2 py-0.5 hover:bg-gray-200">{t}</a>
          ))}
        </div>
      )}

      {entry.data.heroImage && (
        <img src={entry.data.heroImage} alt="" class="mt-6 rounded" loading="lazy" />
      )}

      {headings && headings.length > 2 && (
        <aside class="mt-6 mb-6 rounded border bg-gray-50 p-4">
          <h2 class="text-sm font-semibold mb-2">On this page</h2>
          <ul class="text-sm space-y-1">
            {headings
              .filter((h) => h.depth <= 3)
              .map((h) => (
                <li style={`margin-left:${(h.depth - 2) * 12}px`}>
                  <a href={`#${h.slug}`} class="hover:underline">{h.text}</a>
                </li>
              ))}
          </ul>
        </aside>
      )}

      <article class="prose prose-slate max-w-none">
        {Content && <Content />}
      </article>

      {entry.data.canonical && (
        <p class="mt-8 text-xs text-gray-500">
          Originally published at{" "}
          <a href={entry.data.canonical} class="underline">{entry.data.canonical}</a>
        </p>
      )}
    </section>
  ) : (
    <section class="container py-16">
      <h1 class="text-2xl font-bold mb-2">Article not found</h1>
      <p class="text-gray-600">The article you requested does not exist or may have been moved.</p>
      <a href="/articles/" class="inline-block mt-4 text-primary hover:underline">Browse all articles →</a>
    </section>
  )}
</BaseLayout>